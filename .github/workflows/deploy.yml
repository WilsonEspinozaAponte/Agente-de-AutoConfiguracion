name: Deploy Cloud MVP
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Necesario para comentar en el PR
      contents: read
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Copiar archivos al servidor
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./*" # Copia todo el contenido del repo
          target: "/home/ubuntu/agente-app"

      - name: Ejecutar Agente y capturar nombre
        uses: appleboy/ssh-action@master
        id: run_agent # ID para capturar la salida después
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Preparar entorno
            sudo apt-get update
            sudo apt-get install -y python3-venv

            # 2. Preparar el directorio
            cd /home/ubuntu/agente-app

            # 3. Crear y activar un entorno virtual (Soluciona error PEP 668)
            # Esto aisla las librerías del proyecto del sistema operativo
            python3 -m venv venv
            source venv/bin/activate

            # 4. Instalar dependencias DENTRO del entorno virtual
            pip install -r requirements.txt

            # 5. Ejecutar el despliegue
            # Capturamos el nombre del entorno para el siguiente paso
            echo "Iniciando despliegue..."
            python agente.py deploy -f example/docker-compose.yml > deploy_output.txt 2>&1
            
            # Leemos el archivo para ver qué pasó (para los logs de GitHub)
            cat deploy_output.txt
            
            # BUSCAMOS el nombre del entorno en la salida. 
            # El agente imprime: "¡Entorno 'autotest-env-xxxxx' desplegado...!"
            # Usamos grep y awk para extraer solo el ID.
            ENV_NAME=$(grep -oP "autotest-env-[a-z0-9]+" deploy_output.txt | head -1)
            
            if [ -z "$ENV_NAME" ]; then
              echo "Error: No se pudo capturar el nombre del entorno."
              exit 1
            fi
            
            echo "Entorno detectado: $ENV_NAME"
            
            # Para el comentario automático dinámico real, necesitamos extraerlo del stdout del step.
            echo "::set-output name=env_name::$ENV_NAME"

      - name: Comentar en el Pull Request
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Entorno de Pruebas Desplegado**
            
            ¡Tu entorno está listo en la nube!
            
            **URL:** http://${{ steps.run_agent.outputs.env_name }}.${{ secrets.HOST_DNS }}.nip.io
            
            *El entorno se destruirá automáticamente al cerrar este PR.*