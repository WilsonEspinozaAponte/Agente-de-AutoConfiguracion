name: Deploy Cloud MVP
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Necesario para comentar en el PR
      contents: read
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Copiar archivos al servidor
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./*"
          target: "/home/ubuntu/agente-app"

      - name: Ejecutar Agente en el servidor
        uses: appleboy/ssh-action@master
        id: run_agent # ID importante para referenciarlo después
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Preparar entorno
            sudo apt-get update
            sudo apt-get install -y python3-venv
            cd /home/ubuntu/agente-app
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

            # 2. Ejecutar despliegue y capturar SOLAMENTE la última línea (el nombre)
            # Ejecutamos el deploy y filtramos la salida para encontrar el nombre.
            
            echo "Iniciando despliegue..."
            python agente.py deploy -f example/docker-compose.yml > deploy_output.txt 2>&1
            
            # Leemos el archivo para ver qué pasó (para los logs de GitHub)
            cat deploy_output.txt
            
            # Buscamos el nombre del entorno en la salida. 
            ENV_NAME=$(grep -oP "autotest-env-[a-z0-9]+" deploy_output.txt | head -1)
            
            if [ -z "$ENV_NAME" ]; then
              echo "Error: No se pudo capturar el nombre del entorno."
              exit 1
            fi
            
            echo "Entorno detectado: $ENV_NAME"
            
            echo "$ENV_NAME" > /home/ubuntu/agente-app/last_env.txt

            # nohup: Evita que el proceso muera al cerrar SSH
            # &: Ejecuta en segundo plano
            # > monitor.log: Guarda los logs para poder verlos luego
            echo "Iniciando Auto-Healing y Auto-Optimization en segundo plano..."
            nohup python -u agente.py monitor -f example/docker-compose.yml $ENV_NAME > monitor.log 2>&1 &
            
            echo "Agente de monitoreo activo en segundo plano (PID: $!)."

      - name: Recuperar Nombre del Entorno
        id: get_env_name
        run: |
          # 1. Crear archivo de llave temporal para conectar por SSH manual
          echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          
          # 2. Leer el archivo remoto usando SSH estándar y guardarlo en variable local
          # (StrictHostKeyChecking=no evita que pregunte 'yes/no' al conectar)
          RETRIEVED_NAME=$(ssh -o StrictHostKeyChecking=no -i private_key.pem ${{ secrets.USERNAME }}@${{ secrets.HOST_DNS }} "cat /home/ubuntu/agente-app/last_env.txt")
          
          echo "Nombre recuperado desde AWS: $RETRIEVED_NAME"
          
          # 3. Guardar en la variable de salida de GitHub
          echo "env_name=$RETRIEVED_NAME" >> $GITHUB_OUTPUT
          
          # 4. Limpieza de seguridad
          rm private_key.pem

      - name: Comentar en el Pull Request
        uses: thollander/actions-comment-pull-request@v2
        if: success()
        with:
          message: |
            **Entorno de Pruebas Desplegado**
            
            ¡El sistema autonómico ha desplegado tu entorno! ☁️
            
            **Estado:** Activo
            **URL:** http://${{ steps.get_env_name.outputs.env_name }}.${{ secrets.HOST_DNS }}.nip.io
            
            *El entorno se destruirá automáticamente al cerrar este PR.*