name: Deploy Cloud MVP
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Necesario para comentar en el PR
      contents: read
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Copiar archivos al servidor
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./*" # Copia todo el contenido del repo
          target: "/home/ubuntu/agente-app"

      - name: Ejecutar Agente en el Servidor
        uses: appleboy/ssh-action@master
        id: run_agent # ID para capturar la salida después
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Instalar dependencias en el servidor (si no existen)
            sudo apt-get install -y python3-pip
            pip3 install -r /home/ubuntu/agente-app/requirements.txt
            
            # 2. Ejecutar el despliegue
            cd /home/ubuntu/agente-app
            # Capturamos solo el nombre del entorno de la salida
            # (El script de Python debería imprimir el nombre al final o lo parseamos)
            python3 agent.py deploy -f example/docker-compose.yml

      - name: Comentar en el Pull Request
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Entorno de Pruebas Desplegado**
            
            ¡Tu entorno está listo en la nube!
            
            **URL:** http://[nombre-del-entorno].${{ secrets.HOST_DNS }}.nip.io
            
            *(Nota: Reemplaza [nombre-del-entorno] manualmente por ahora o ajusta el script para capturar la salida exacta)*