name: Deploy Cloud MVP
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Necesario para comentar en el PR
      contents: read
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Copiar archivos al servidor
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./*" # Copia todo el contenido del repo
          target: "/home/ubuntu/agente-app"

      - name: Ejecutar Agente en el Servidor
        uses: appleboy/ssh-action@master
        id: run_agent # ID para capturar la salida después
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Instalar venv en el sistema (necesario para Ubuntu 24.04)
            sudo apt-get update
            sudo apt-get install -y python3-venv
            
            # 2. Preparar el directorio
            cd /home/ubuntu/agente-app

            # 3. Crear y activar un entorno virtual (Soluciona error PEP 668)
            # Esto aisla las librerías del proyecto del sistema operativo
            python3 -m venv venv
            source venv/bin/activate

            # 4. Instalar dependencias DENTRO del entorno virtual
            pip install -r requirements.txt

            # 5. Ejecutar el despliegue
            # Capturamos el nombre del entorno para el siguiente paso
            OUTPUT=$(python agente.py deploy -f example/docker-compose.yml)
            echo "$OUTPUT"

      - name: Comentar en el Pull Request
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Entorno de Pruebas Desplegado**
            
            ¡Tu entorno está listo en la nube!
            
            **URL:** http://[nombre-del-entorno].${{ secrets.HOST_DNS }}.nip.io
            
            *(Nota: Reemplaza [nombre-del-entorno] manualmente por ahora o ajusta el script para capturar la salida exacta)*