name: Deploy Cloud MVP
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Necesario para comentar en el PR
      contents: read
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v3

      - name: Copiar archivos al servidor
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./*"
          target: "/home/ubuntu/agente-app"

      - name: Ejecutar Agente y Capturar Nombre
        uses: appleboy/ssh-action@master
        id: run_agent # ID importante para referenciarlo después
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Preparar entorno
            sudo apt-get update
            sudo apt-get install -y python3-venv
            cd /home/ubuntu/agente-app
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt

            # 2. Ejecutar despliegue y capturar SOLAMENTE la última línea (el nombre)
            # Ejecutamos el deploy y filtramos la salida para encontrar el nombre.
            
            echo "Iniciando despliegue..."
            python agente.py deploy -f example/docker-compose.yml > deploy_output.txt 2>&1
            
            # Leemos el archivo para ver qué pasó (para los logs de GitHub)
            cat deploy_output.txt
            
            # BUSCAMOS el nombre del entorno en la salida. 
            # El agente imprime: "¡Entorno 'autotest-env-xxxxx' desplegado...!"
            # Usamos grep y awk para extraer solo el ID.
            ENV_NAME=$(grep -oP "autotest-env-[a-z0-9]+" deploy_output.txt | head -1)
            
            if [ -z "$ENV_NAME" ]; then
              echo "Error: No se pudo capturar el nombre del entorno."
              exit 1
            fi
            
            echo "Entorno detectado: $ENV_NAME"
            
            # Para pasar una variable desde SSH al siguiente paso de GitHub, es complejo.
            # Lo más fácil para este prototipo es escribir el nombre en un archivo que el siguiente paso pueda "adivinar" 
            # o simplemente imprimirlo de una forma específica.
            
            # Pero dado que estamos dentro de SSH, el 'output' del step es todo el texto.
            # Vamos a simplificar: El usuario verá el log y confirmará.
            # Para el comentario automático dinámico real, necesitamos extraerlo del stdout del step.
            echo "::set-output name=env_name::$ENV_NAME"

      - name: Comentar en el Pull Request
        uses: thollander/actions-comment-pull-request@v2
        if: success()
        with:
          message: |
            **Entorno de Pruebas Desplegado**
            
            ¡El sistema autonómico ha desplegado tu entorno! ☁️
            
            **Estado:** Activo
            **URL:** http://${{ steps.run_agent.outputs.env_name }}.${{ secrets.HOST_DNS }}.nip.io
            
            *El entorno se destruirá automáticamente al cerrar este PR.*